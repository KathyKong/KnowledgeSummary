# 性能优化1/5 -- 绘制优化

* Android系统显示原理
* 布局优化
* 避免过度绘制
* 启动优化
* 合理刷新机制
* 提升动画性能


### Android系统显示原理
简单来说，就是应用层通过Measure、Layout、Draw，产生Surface缓存数据。然后通过进程间通信(匿名共享内存 SharedClient)，把缓存数据交给系统层，利用SurfaceFlinger把数据渲染到屏幕。

Android的图形显示系统采用Client/Server架构。其中每个应用程序都是Client，系统是Server。

每个应用和SurfaceFlinger之间，都会创建一个SharedClient，即一个SharedClient对应一个应用程序。而每个SharedClient中，最多可创建31个SharedBufferStack，即SharedClient包含SharedBufferStack的集合。其中，每个Surface都对应一个SharedBufferStack，也就是一个Window。这就意味着，一个应用程序同时做多包含31个窗口。

![Android显示框架](https://raw.githubusercontent.com/hningoba/KnowledgeSummary/master/img/Android显示框架.jpg)

### 布局优化

###### 布局优化的工具

1.Hierarchy Viewer

Tools -> Android -> Android Device Monitor中，打开Hierarchy Viewer。
可监测对程序当前页面布局情况。可查看布局的层级和每个节点的耗时情况。

2.Android Lint

扫描规则和缺陷级别可在 File->Settings->Inspections->Android Lint 中配置。

配置项：

* TooDeepLayout: 表示布局太深，默认超过10层提示；
* TooManyViews: 控件太多，默认超过80个控件会提示该问题；

启动lint后，Studio会给出扫描结果。根据结果优化对应布局文件即可。


###### 布局优化的方法
可从3个方面优化布局。

1.减少布局层级

可以使用<merge>标签、RelativeLayout或ConstraintLayout等。很简单，不用细说。

2.提高显示速度

可以使用ViewStub，初始状态不会加载显示ViewStub指定的布局。只有当ViewStub显示时，或调用ViewStub.infalte()时，其指定的布局才会被加载和实例化。常用于网络异常提示等情况。

3.布局的复用

通用的布局，可以使用<include>标签。


### 避免过度绘制

过度绘制：Overdraw，指屏幕上某个像素在同一帧的时间内被绘制多次。

过度绘制的主要原因：

* XML布局：控件有重叠且都设置背景
* View自绘：View.onDraw()里同一区域被绘制多次

如果控件重叠多层，绘制每一层时，都会导致该区域被绘制。这种叠加就很容易导致过度绘制。

检测方法：

* Hierarchy Viewer：查看布局层级，降低层级；
* 手机设置中“GPU过度重绘”：通过颜色粗略判断Overdraw情况。

无色：没有过渡绘制，每个像素绘制1次；
蓝色：每个像素多绘制1次；
绿色：每个像素多绘制2次；
淡红色：每个像素多绘制3次；
深红色：每个像素多绘制4次或更多；
